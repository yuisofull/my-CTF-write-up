#https://github.com/mimoo/RSA-and-LLL-attacks
load('coppersmith.sage')

a=182536
b=732597
n=3964970058588757148381961704143056706462468814335020245520977895524549102412775370911197710398920529632256746343939593559572847418983212937475829291172342816906345995624544182017120655442222795822907477729458438770162855927353619566468727681852742079784144920419652981178832687838498834941068480219482245959017445310420267641793085925693920024598052216950355088176712030006651946591651283046071005648582501424036467542988971212512830176367114664519888193885765301505532337644978456428464159474089450883733342365659030987687637355512103402573155030916404165387863932234088255017821889649456947853403395704387479968208359004918561

pbar=int(sqrt((n*a)//b))
#pbar = 31431249988172282588448767875539383078270520610885068858894594350040664294089631831898187839710370441685270767030754635557928414643087264016495427842079478763643372414136339623006540800843405451786607424682100946753383337801951498820760959568845485725209680154766381660072139426976483488363969641119125867322591348
#qbar = 126147387077535662595048658890939460846034473133916426298481412636722293355048768523212498996407822317062411294837345804366435567681343956023428260457246241310258559156257172605810395532187981412090104079016576196017083803077026389340540639850756027911183773653331531447828941243621588769539095924427240744686718714
lbits=500
while True:
    ln = 2^lbits
    p_length=1042
    q_length=1044
    p_high=pbar//ln

    p0=p_high

    # Recovery starts here
    q0 = floor(n / (p0*ln))//ln
    print("q0 bit lengths: ", len(bin(q0))-2)
    X = Y = 2^(lbits+2) # bounds on x0 and y0


    bounds = (X,Y)
    R = Integers(n)
    PR.<x, y> = PolynomialRing(Zmod(n))

    f = (x+p0*ln)*(y+q0*ln)

    r=small_roots(f, bounds)
    if r == []:
        lbits = lbits + 1
        continue
    print(small_roots(f, bounds))

    print("p = ", p0*ln+r[0][0])
    break
